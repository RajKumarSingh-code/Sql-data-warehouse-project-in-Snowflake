CREATE OR REPLACE PROCEDURE DATAWAREHOUSE.BRONZE.SP_LOAD_BRONZE()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS 'DECLARE
    RESULTT STRING;
    START_TIME TIMESTAMP;
    END_TIME TIMESTAMP;
    DIFF INTEGER;
    ROW_COUNT INTEGER;
    BATCH_START_TIME TIMESTAMP;
    BATCH_END_TIME TIMESTAMP;
BEGIN
    BEGIN
        BATCH_START_TIME := CURRENT_TIMESTAMP();
    --  FULL LOAD
        START_TIME := CURRENT_TIMESTAMP();
        TRUNCATE TABLE DATAWAREHOUSE.BRONZE.CRM_CUST_INFO;
    
    -- USING COPY COMMAND TO LOAD DATA FORM STAGE TO TABLE
        COPY INTO DATAWAREHOUSE.BRONZE.CRM_CUST_INFO
        FROM @CRM_DATA
        FILES = (''cust_info.csv.gz'')
        FILE_FORMAT = DATAWAREHOUSE.BRONZE.FILE_FORMAT_CRM_CUST_INFO;
        
        END_TIME := CURRENT_TIMESTAMP();
        SELECT COUNT(*) INTO :ROW_COUNT FROM DATAWAREHOUSE.BRONZE.CRM_CUST_INFO;
        DIFF := DATEDIFF(''SECONDS'', START_TIME, END_TIME);
        INSERT INTO DATAWAREHOUSE.BRONZE.BRONZE_LOGS VALUES(LOG_ID.NEXTVAL, ''DATAWAREHOUSE.BRONZE.CRM_CUST_INFO'',:START_TIME, :END_TIME, :DIFF, :ROW_COUNT);



        START_TIME := CURRENT_TIMESTAMP();
    -- DDL FOR DATAWAREHOUSE.BRONZE.CRM_PRODUCT_INFO TABLE
        TRUNCATE TABLE DATAWAREHOUSE.BRONZE.CRM_PRODUCT_INFO;
    
    -- USING COPY COMMAND TO LOAD DATA FORM STAGE TO TABLE
        COPY INTO DATAWAREHOUSE.BRONZE.CRM_PRODUCT_INFO
        FROM @CRM_DATA
        FILES = (''prd_info.csv.gz'')
        FILE_FORMAT = DATAWAREHOUSE.BRONZE.FILE_FORMAT_CRM_CUST_INFO;
        END_TIME := CURRENT_TIMESTAMP();
        DIFF := DATEDIFF(''SECONDS'', START_TIME, END_TIME);
        SELECT COUNT(*) INTO :ROW_COUNT FROM DATAWAREHOUSE.BRONZE.CRM_PRODUCT_INFO;
        INSERT INTO DATAWAREHOUSE.BRONZE.BRONZE_LOGS VALUES(LOG_ID.NEXTVAL, ''DATAWAREHOUSE.BRONZE.CRM_PRODUCT_INFO'',:START_TIME, :END_TIME, :DIFF, :ROW_COUNT);


        START_TIME := CURRENT_TIMESTAMP();
    -- DDL FOR DATAWAREHOUSE.BRONZE.CRM_SALES_INFO TABLE
        TRUNCATE TABLE DATAWAREHOUSE.BRONZE.CRM_SALES_INFO;
    
    -- USING COPY COMMAND TO LOAD DATA FORM STAGE TO TABLE
        COPY INTO DATAWAREHOUSE.BRONZE.CRM_SALES_INFO
        FROM @CRM_DATA
        FILES = (''sales_details.csv.gz'')
        FILE_FORMAT = DATAWAREHOUSE.BRONZE.FILE_FORMAT_CRM_CUST_INFO;
        END_TIME := CURRENT_TIMESTAMP();
        DIFF := DATEDIFF(''SECONDS'', START_TIME, END_TIME);
        SELECT COUNT(*) INTO :ROW_COUNT FROM DATAWAREHOUSE.BRONZE.CRM_SALES_INFO;
        INSERT INTO DATAWAREHOUSE.BRONZE.BRONZE_LOGS VALUES(LOG_ID.NEXTVAL, ''DATAWAREHOUSE.BRONZE.CRM_SALES_INFO'',:START_TIME, :END_TIME, :DIFF, :ROW_COUNT);

        
        START_TIME := CURRENT_TIMESTAMP();
    -- DDL FOR DATAWAREHOUSE.BRONZE.ERP_CUST_AZ12 TABLE
        TRUNCATE TABLE DATAWAREHOUSE.BRONZE.ERP_CUST_AZ12;
    
    -- DDL FOR DATAWAREHOUSE.BRONZE.ERP_CUST_AZ12 TABLE
        COPY INTO DATAWAREHOUSE.BRONZE.ERP_CUST_AZ12
        FROM @CRM_DATA
        FILES = (''CUST_AZ12.csv.gz'')
        FILE_FORMAT = DATAWAREHOUSE.BRONZE.FILE_FORMAT_CRM_CUST_INFO;
        END_TIME := CURRENT_TIMESTAMP();
        DIFF := DATEDIFF(''SECONDS'', START_TIME, END_TIME);
        SELECT COUNT(*) INTO :ROW_COUNT FROM DATAWAREHOUSE.BRONZE.ERP_CUST_AZ12;
        INSERT INTO DATAWAREHOUSE.BRONZE.BRONZE_LOGS VALUES(LOG_ID.NEXTVAL, ''DATAWAREHOUSE.BRONZE.ERP_CUST_AZ12'',:START_TIME, :END_TIME, :DIFF, :ROW_COUNT);

        START_TIME := CURRENT_TIMESTAMP();
    -- DDL FOR DATAWAREHOUSE.BRONZE.ERP_LOC_A101 TABLE
        TRUNCATE TABLE DATAWAREHOUSE.BRONZE.ERP_LOC_A101;
    
    -- DDL FOR DATAWAREHOUSE.BRONZE.ERP_CUST_AZ12 TABLE
        COPY INTO DATAWAREHOUSE.BRONZE.ERP_LOC_A101
        FROM @CRM_DATA
        FILES = (''LOC_A101.csv.gz'')
        FILE_FORMAT = DATAWAREHOUSE.BRONZE.FILE_FORMAT_CRM_CUST_INFO;
        END_TIME := CURRENT_TIMESTAMP();
        DIFF := DATEDIFF(''SECONDS'', START_TIME, END_TIME);
        SELECT COUNT(*) INTO :ROW_COUNT FROM DATAWAREHOUSE.BRONZE.ERP_LOC_A101;
        INSERT INTO DATAWAREHOUSE.BRONZE.BRONZE_LOGS VALUES(LOG_ID.NEXTVAL, ''DATAWAREHOUSE.BRONZE.ERP_LOC_A101'',:START_TIME, :END_TIME, :DIFF, :ROW_COUNT);

        START_TIME := CURRENT_TIMESTAMP();
    -- DDL FOR DATAWAREHOUSE.BRONZE.ERP_PX_CAT_G1V2 TABLE
        TRUNCATE TABLE DATAWAREHOUSE.BRONZE.ERP_PX_CAT_G1V2;
    
    -- DDL FOR DATAWAREHOUSE.BRONZE.ERP_CUST_AZ12 TABLE
        COPY INTO DATAWAREHOUSE.BRONZE.ERP_PX_CAT_G1V2
        FROM @CRM_DATA
        FILES = (''PX_CAT_G1V2.csv.gz'')
        FILE_FORMAT = DATAWAREHOUSE.BRONZE.FILE_FORMAT_CRM_CUST_INFO;
        END_TIME := CURRENT_TIMESTAMP();
        DIFF := DATEDIFF(''SECONDS'', START_TIME, END_TIME);
        SELECT COUNT(*) INTO :ROW_COUNT FROM DATAWAREHOUSE.BRONZE.ERP_PX_CAT_G1V2;
        INSERT INTO DATAWAREHOUSE.BRONZE.BRONZE_LOGS VALUES(LOG_ID.NEXTVAL, ''DATAWAREHOUSE.BRONZE.ERP_PX_CAT_G1V2'',:START_TIME, :END_TIME, :DIFF, :ROW_COUNT);
    
    -- USED PUT FILE COMMAND IN SNOWSQL IN ORDER TO LOAD THE DATA FROM LOCAL SYSTEM TO SNOWFLAKE STAGE
    -- put file://C:\\Users\\rajsi\\Downloads\\sql-data-warehouse-project\\sql-data-warehouse-project\\datasets\\source_erp\\CUST_AZ12.csv @CRM_DATA;
        BATCH_END_TIME := CURRENT_TIMESTAMP();
        DIFF := DATEDIFF(''SECONDS'', BATCH_START_TIME, BATCH_END_TIME);
        SELECT SUM(ROW_COUNT) INTO :ROW_COUNT FROM DATAWAREHOUSE.BRONZE.BRONZE_LOGS;
        INSERT INTO DATAWAREHOUSE.BRONZE.BRONZE_LOGS VALUES(LOG_ID.NEXTVAL, ''TOTAL_BATCH_PROCESS'',:BATCH_START_TIME, :BATCH_END_TIME, :DIFF, :ROW_COUNT);
        
        RESULTT := ''LOAD COMPLETED IN BRONZE LAYER'';
        RETURN RESULTT;
    
        EXCEPTION
        WHEN OTHER THEN
          RESULTT := ''ERROR: '' || ERROR_MESSAGE() || '' ERROR_NUMBER: '' || ERROR_NUMBER()::VARCHAR;
          RETURN RESULTT;
    END;
END';
